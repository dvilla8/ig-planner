var A=Object.defineProperty;var S=(e,t,i)=>t in e?A(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var w=(e,t,i)=>(S(e,typeof t!="symbol"?t+"":t,i),i);import{aL as x,aM as I,aN as g,q as M,aO as T}from"./Dd-faj7m.js";import{a as k,V as _}from"./DcG8lQgK.js";import{V as L}from"./Cjfrz8xr.js";import{V as E}from"./Dc3oaTmH.js";import{d as O,Q as C,V as D,Z as P,l as y,a5 as F}from"./D-drnA8r.js";const b=(()=>{if(typeof self>"u")return!1;if("top"in self&&self!==top)try{top.window.document._=0}catch{return!1}return"showOpenFilePicker"in self})();b?Promise.resolve().then(function(){return B}):Promise.resolve().then(function(){return K});const R=b?Promise.resolve().then(function(){return $}):Promise.resolve().then(function(){return Z});async function j(...e){return(await R).default(...e)}b?Promise.resolve().then(function(){return q}):Promise.resolve().then(function(){return G});const V=async e=>{const t=await e.getFile();return t.handle=e,t};var N=async(e=[{}])=>{Array.isArray(e)||(e=[e]);const t=[];e.forEach((a,l)=>{t[l]={description:a.description||"Files",accept:{}},a.mimeTypes?a.mimeTypes.map(o=>{t[l].accept[o]=a.extensions||[]}):t[l].accept["*/*"]=a.extensions||[]});const i=await window.showOpenFilePicker({id:e[0].id,startIn:e[0].startIn,types:t,multiple:e[0].multiple||!1,excludeAcceptAllOption:e[0].excludeAcceptAllOption||!1}),r=await Promise.all(i.map(V));return e[0].multiple?r:r[0]},B={__proto__:null,default:N};function h(e){function t(i){if(Object(i)!==i)return Promise.reject(new TypeError(i+" is not an object."));var r=i.done;return Promise.resolve(i.value).then(function(a){return{value:a,done:r}})}return h=function(i){this.s=i,this.n=i.next},h.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(i){var r=this.s.return;return r===void 0?Promise.resolve({value:i,done:!0}):t(r.apply(this.s,arguments))},throw:function(i){var r=this.s.return;return r===void 0?Promise.reject(i):t(r.apply(this.s,arguments))}},new h(e)}const U=async(e,t,i=e.name,r)=>{const a=[],l=[];var o,n=!1,s=!1;try{for(var u,p=function(c){var m,d,f,v=2;for(typeof Symbol<"u"&&(d=Symbol.asyncIterator,f=Symbol.iterator);v--;){if(d&&(m=c[d])!=null)return m.call(c);if(f&&(m=c[f])!=null)return new h(m.call(c));d="@@asyncIterator",f="@@iterator"}throw new TypeError("Object is not async iterable")}(e.values());n=!(u=await p.next()).done;n=!1){const c=u.value,m=`${i}/${c.name}`;c.kind==="file"?l.push(c.getFile().then(d=>(d.directoryHandle=e,d.handle=c,Object.defineProperty(d,"webkitRelativePath",{configurable:!0,enumerable:!0,get:()=>m})))):c.kind!=="directory"||!t||r&&r(c)||a.push(U(c,t,m,r))}}catch(c){s=!0,o=c}finally{try{n&&p.return!=null&&await p.return()}finally{if(s)throw o}}return[...(await Promise.all(a)).flat(),...await Promise.all(l)]};var W=async(e={})=>{e.recursive=e.recursive||!1,e.mode=e.mode||"read";const t=await window.showDirectoryPicker({id:e.id,startIn:e.startIn,mode:e.mode});return(await(await t.values()).next()).done?[t]:U(t,e.recursive,void 0,e.skipDirectory)},$={__proto__:null,default:W},H=async(e,t=[{}],i=null,r=!1,a=null)=>{Array.isArray(t)||(t=[t]),t[0].fileName=t[0].fileName||"Untitled";const l=[];let o=null;if(e instanceof Blob&&e.type?o=e.type:e.headers&&e.headers.get("content-type")&&(o=e.headers.get("content-type")),t.forEach((u,p)=>{l[p]={description:u.description||"Files",accept:{}},u.mimeTypes?(p===0&&o&&u.mimeTypes.push(o),u.mimeTypes.map(c=>{l[p].accept[c]=u.extensions||[]})):o?l[p].accept[o]=u.extensions||[]:l[p].accept["*/*"]=u.extensions||[]}),i)try{await i.getFile()}catch(u){if(i=null,r)throw u}const n=i||await window.showSaveFilePicker({suggestedName:t[0].fileName,id:t[0].id,startIn:t[0].startIn,types:l,excludeAcceptAllOption:t[0].excludeAcceptAllOption||!1});!i&&a&&a(n);const s=await n.createWritable();return"stream"in e?(await e.stream().pipeTo(s),n):"body"in e?(await e.body.pipeTo(s),n):(await s.write(await e),await s.close(),n)},q={__proto__:null,default:H},J=async(e=[{}])=>(Array.isArray(e)||(e=[e]),new Promise((t,i)=>{const r=document.createElement("input");r.type="file";const a=[...e.map(s=>s.mimeTypes||[]),...e.map(s=>s.extensions||[])].join();r.multiple=e[0].multiple||!1,r.accept=a||"",r.style.display="none",document.body.append(r);const l=s=>{typeof o=="function"&&o(),t(s)},o=e[0].legacySetup&&e[0].legacySetup(l,()=>o(i),r),n=()=>{window.removeEventListener("focus",n),r.remove()};r.addEventListener("click",()=>{window.addEventListener("focus",n)}),r.addEventListener("change",()=>{window.removeEventListener("focus",n),r.remove(),l(r.multiple?Array.from(r.files):r.files[0])}),"showPicker"in HTMLInputElement.prototype?r.showPicker():r.click()})),K={__proto__:null,default:J},Q=async(e=[{}])=>(Array.isArray(e)||(e=[e]),e[0].recursive=e[0].recursive||!1,new Promise((t,i)=>{const r=document.createElement("input");r.type="file",r.webkitdirectory=!0;const a=o=>{typeof l=="function"&&l(),t(o)},l=e[0].legacySetup&&e[0].legacySetup(a,()=>l(i),r);r.addEventListener("change",()=>{let o=Array.from(r.files);e[0].recursive?e[0].recursive&&e[0].skipDirectory&&(o=o.filter(n=>n.webkitRelativePath.split("/").every(s=>!e[0].skipDirectory({name:s,kind:"directory"})))):o=o.filter(n=>n.webkitRelativePath.split("/").length===2),a(o)}),"showPicker"in HTMLInputElement.prototype?r.showPicker():r.click()})),Z={__proto__:null,default:Q},z=async(e,t={})=>{Array.isArray(t)&&(t=t[0]);const i=document.createElement("a");let r=e;"body"in e&&(r=await async function(o,n){const s=o.getReader(),u=new ReadableStream({start:m=>async function d(){return s.read().then(({done:f,value:v})=>{if(!f)return m.enqueue(v),d();m.close()})}()}),p=new Response(u),c=await p.blob();return s.releaseLock(),new Blob([c],{type:n})}(e.body,e.headers.get("content-type"))),i.download=t.fileName||"Untitled",i.href=URL.createObjectURL(await r);const a=()=>{typeof l=="function"&&l()},l=t.legacySetup&&t.legacySetup(a,()=>l(),i);return i.addEventListener("click",()=>{setTimeout(()=>URL.revokeObjectURL(i.href),3e4),a()}),i.click(),null},G={__proto__:null,default:z};async function X(){return j({recursive:!0,mode:"readwrite",startIn:"documents",id:"import-profile",skipDirectory:t=>t.name[0]==="."})}async function Y(e){return new Promise((t,i)=>{let r=new FileReader;r.readAsText(e),r.onload=function(){typeof r.result!="string"?i("Directory does not contain a valid config.json"):t(JSON.parse(r.result))},r.onerror=i})}class ee{constructor(t){w(this,"directory",null);w(this,"platform","");w(this,"rawUser",{});this.platform=t}async importFromDirectory(){const t=x(this.platform);this.directory=await X(),this.rawUser=await Y(this.configFile),this.rawUser.profile.avatar=this.avatarFile;for(const i of Object.keys(t.user.media.collections))this.rawUser.media.hasOwnProperty(i)&&this.importRawMediaFilesByCollection(i);return this.rawUser.origin="storage",this.rawUser.platform=I(this.rawUser),this.rawUser}get configFile(){return this.directory.find(t=>t.name==="config.json")}importRawMediaFilesByCollection(t){var l,o;let i=0,r={},a={};for(const n of this.rawUser.media[t]){if(r={},typeof n=="string")r.type=g.detectMediaType(n),n.startsWith("http")||(r.file=this.getMediaFile(n));else if(n.type)switch(n.type||(n.type=g.detectMediaType(n)),r.type=n.type,n.type){case"image":n.name&&!((l=n.name)!=null&&l.startsWith("http"))&&(r.file=this.getMediaFile(n.name));break;case"video":n.name&&!n.name.startsWith("http")&&(r.file=this.getMediaFile(n.name)),n.cover&&typeof n.cover=="string"&&!((o=n.cover)!=null&&o.startsWith("http"))&&(r.cover={file:this.getMediaFile(n.cover)});break;case"album":if(r.list=[],Array.isArray(n.list))for(const s of n.list)a={},typeof s=="string"?(a.type=g.detectMediaType(s),a.file=this.getMediaFile(s)):s.name&&(a.type=s.type,a.file=this.getMediaFile(s.name)),r.list.push(a);break;case"iframe":n.cover&&typeof n.cover=="string"&&!n.cover.startsWith("http")&&(r.cover={file:this.getMediaFile(n.cover)});break}this.rawUser.media[t][i]=r,i++}}get avatarFile(){return this.directory.find(t=>t.name===this.rawUser.profile.avatar)}getMediaFile(t){return this.directory.find(i=>i.name===t)}}const se=O({__name:"UserSelectorAddMenuOptions",emits:["openCreateProfileDialog"],setup(e,{emit:t}){const i=M(),r=T(),a=t;async function l(){const n=await new ee("instagram").importFromDirectory(),s=await i.loadUser(n);await s.loadUserClient(),await s.save(),r.addUserToStorageIndex({username:s.raw.profile.username,platform:"instagram"})}return(o,n)=>(C(),D(E,{border:"",elevation:0},{default:P(()=>[y(k,{onClick:n[0]||(n[0]=s=>a("openCreateProfileDialog"))},{default:P(()=>[y(_,{textContent:F(o.$t("common.actions.createProfile"))},null,8,["textContent"])]),_:1}),y(L),y(k,{onClick:l},{default:P(()=>[y(_,{textContent:F(o.$t("common.actions.importProfile"))},null,8,["textContent"])]),_:1})]),_:1}))}});export{se as _};
