var A=Object.defineProperty;var S=(e,t,i)=>t in e?A(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var y=(e,t,i)=>S(e,typeof t!="symbol"?t+"":t,i);import{bL as x,bS as I,bT as g,e as T,R as M,bU as E,o as L,c as O,b as w,w as P,t as k,F as C}from"./DM9sX13V.js";import{V as F,a as _}from"./DmyK9oUG.js";const b=(()=>{if(typeof self>"u")return!1;if("top"in self&&self!==top)try{top.window.document._=0}catch{return!1}return"showOpenFilePicker"in self})();b?Promise.resolve().then(function(){return B}):Promise.resolve().then(function(){return J});const R=b?Promise.resolve().then(function(){return $}):Promise.resolve().then(function(){return z});async function D(...e){return(await R).default(...e)}b?Promise.resolve().then(function(){return H}):Promise.resolve().then(function(){return Q});const j=async e=>{const t=await e.getFile();return t.handle=e,t};var N=async(e=[{}])=>{Array.isArray(e)||(e=[e]);const t=[];e.forEach((o,l)=>{t[l]={description:o.description||"Files",accept:{}},o.mimeTypes?o.mimeTypes.map(a=>{t[l].accept[a]=o.extensions||[]}):t[l].accept["*/*"]=o.extensions||[]});const i=await window.showOpenFilePicker({id:e[0].id,startIn:e[0].startIn,types:t,multiple:e[0].multiple||!1,excludeAcceptAllOption:e[0].excludeAcceptAllOption||!1}),r=await Promise.all(i.map(j));return e[0].multiple?r:r[0]},B={__proto__:null,default:N};function h(e){function t(i){if(Object(i)!==i)return Promise.reject(new TypeError(i+" is not an object."));var r=i.done;return Promise.resolve(i.value).then(function(o){return{value:o,done:r}})}return h=function(i){this.s=i,this.n=i.next},h.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(i){var r=this.s.return;return r===void 0?Promise.resolve({value:i,done:!0}):t(r.apply(this.s,arguments))},throw:function(i){var r=this.s.return;return r===void 0?Promise.reject(i):t(r.apply(this.s,arguments))}},new h(e)}const U=async(e,t,i=e.name,r)=>{const o=[],l=[];var a,n=!1,s=!1;try{for(var u,p=function(c){var f,m,d,v=2;for(typeof Symbol<"u"&&(m=Symbol.asyncIterator,d=Symbol.iterator);v--;){if(m&&(f=c[m])!=null)return f.call(c);if(d&&(f=c[d])!=null)return new h(f.call(c));m="@@asyncIterator",d="@@iterator"}throw new TypeError("Object is not async iterable")}(e.values());n=!(u=await p.next()).done;n=!1){const c=u.value,f=`${i}/${c.name}`;c.kind==="file"?l.push(c.getFile().then(m=>(m.directoryHandle=e,m.handle=c,Object.defineProperty(m,"webkitRelativePath",{configurable:!0,enumerable:!0,get:()=>f})))):c.kind!=="directory"||!t||r&&r(c)||o.push(U(c,t,f,r))}}catch(c){s=!0,a=c}finally{try{n&&p.return!=null&&await p.return()}finally{if(s)throw a}}return[...(await Promise.all(o)).flat(),...await Promise.all(l)]};var W=async(e={})=>{e.recursive=e.recursive||!1,e.mode=e.mode||"read";const t=await window.showDirectoryPicker({id:e.id,startIn:e.startIn,mode:e.mode});return(await(await t.values()).next()).done?[t]:U(t,e.recursive,void 0,e.skipDirectory)},$={__proto__:null,default:W},V=async(e,t=[{}],i=null,r=!1,o=null)=>{Array.isArray(t)||(t=[t]),t[0].fileName=t[0].fileName||"Untitled";const l=[];let a=null;if(e instanceof Blob&&e.type?a=e.type:e.headers&&e.headers.get("content-type")&&(a=e.headers.get("content-type")),t.forEach((u,p)=>{l[p]={description:u.description||"Files",accept:{}},u.mimeTypes?(p===0&&a&&u.mimeTypes.push(a),u.mimeTypes.map(c=>{l[p].accept[c]=u.extensions||[]})):a?l[p].accept[a]=u.extensions||[]:l[p].accept["*/*"]=u.extensions||[]}),i)try{await i.getFile()}catch(u){if(i=null,r)throw u}const n=i||await window.showSaveFilePicker({suggestedName:t[0].fileName,id:t[0].id,startIn:t[0].startIn,types:l,excludeAcceptAllOption:t[0].excludeAcceptAllOption||!1});!i&&o&&o(n);const s=await n.createWritable();return"stream"in e?(await e.stream().pipeTo(s),n):"body"in e?(await e.body.pipeTo(s),n):(await s.write(await e),await s.close(),n)},H={__proto__:null,default:V},q=async(e=[{}])=>(Array.isArray(e)||(e=[e]),new Promise((t,i)=>{const r=document.createElement("input");r.type="file";const o=[...e.map(s=>s.mimeTypes||[]),...e.map(s=>s.extensions||[])].join();r.multiple=e[0].multiple||!1,r.accept=o||"",r.style.display="none",document.body.append(r);const l=s=>{typeof a=="function"&&a(),t(s)},a=e[0].legacySetup&&e[0].legacySetup(l,()=>a(i),r),n=()=>{window.removeEventListener("focus",n),r.remove()};r.addEventListener("click",()=>{window.addEventListener("focus",n)}),r.addEventListener("change",()=>{window.removeEventListener("focus",n),r.remove(),l(r.multiple?Array.from(r.files):r.files[0])}),"showPicker"in HTMLInputElement.prototype?r.showPicker():r.click()})),J={__proto__:null,default:q},K=async(e=[{}])=>(Array.isArray(e)||(e=[e]),e[0].recursive=e[0].recursive||!1,new Promise((t,i)=>{const r=document.createElement("input");r.type="file",r.webkitdirectory=!0;const o=a=>{typeof l=="function"&&l(),t(a)},l=e[0].legacySetup&&e[0].legacySetup(o,()=>l(i),r);r.addEventListener("change",()=>{let a=Array.from(r.files);e[0].recursive?e[0].recursive&&e[0].skipDirectory&&(a=a.filter(n=>n.webkitRelativePath.split("/").every(s=>!e[0].skipDirectory({name:s,kind:"directory"})))):a=a.filter(n=>n.webkitRelativePath.split("/").length===2),o(a)}),"showPicker"in HTMLInputElement.prototype?r.showPicker():r.click()})),z={__proto__:null,default:K},G=async(e,t={})=>{Array.isArray(t)&&(t=t[0]);const i=document.createElement("a");let r=e;"body"in e&&(r=await async function(a,n){const s=a.getReader(),u=new ReadableStream({start:f=>async function m(){return s.read().then(({done:d,value:v})=>{if(!d)return f.enqueue(v),m();f.close()})}()}),p=new Response(u),c=await p.blob();return s.releaseLock(),new Blob([c],{type:n})}(e.body,e.headers.get("content-type"))),i.download=t.fileName||"Untitled",i.href=URL.createObjectURL(await r);const o=()=>{typeof l=="function"&&l()},l=t.legacySetup&&t.legacySetup(o,()=>l(),i);return i.addEventListener("click",()=>{setTimeout(()=>URL.revokeObjectURL(i.href),3e4),o()}),i.click(),null},Q={__proto__:null,default:G};async function X(){return D({recursive:!0,mode:"readwrite",startIn:"documents",id:"import-profile",skipDirectory:t=>t.name[0]==="."})}async function Y(e){return new Promise((t,i)=>{let r=new FileReader;r.readAsText(e),r.onload=function(){typeof r.result!="string"?i("Directory does not contain a valid config.json"):t(JSON.parse(r.result))},r.onerror=i})}class Z{constructor(t){y(this,"directory",null);y(this,"platform","");y(this,"rawUser",{});this.platform=t}async importFromDirectory(){const t=x(this.platform);this.directory=await X(),this.rawUser=await Y(this.configFile),this.rawUser.profile.avatar=this.avatarFile;for(const i of Object.keys(t.user.media.collections))this.rawUser.media.hasOwnProperty(i)&&this.importRawMediaFilesByCollection(i);return this.rawUser.origin="storage",this.rawUser.platform=I(this.rawUser),this.rawUser}get configFile(){return this.directory.find(t=>t.name==="config.json")}importRawMediaFilesByCollection(t){var l,a;let i=0,r={},o={};for(const n of this.rawUser.media[t]){if(r={},typeof n=="string")r.type=g.detectMediaType(n),n.startsWith("http")||(r.file=this.getMediaFile(n));else if(n.type)switch(n.type||(n.type=g.detectMediaType(n)),r.type=n.type,n.type){case"image":n.name&&!((l=n.name)!=null&&l.startsWith("http"))&&(r.file=this.getMediaFile(n.name));break;case"video":n.name&&!n.name.startsWith("http")&&(r.file=this.getMediaFile(n.name)),n.cover&&typeof n.cover=="string"&&!((a=n.cover)!=null&&a.startsWith("http"))&&(r.cover={file:this.getMediaFile(n.cover)});break;case"album":if(r.list=[],Array.isArray(n.list))for(const s of n.list)o={},typeof s=="string"?(o.type=g.detectMediaType(s),o.file=this.getMediaFile(s)):s.name&&(o.type=s.type,o.file=this.getMediaFile(s.name)),r.list.push(o);break;case"iframe":n.cover&&typeof n.cover=="string"&&!n.cover.startsWith("http")&&(r.cover={file:this.getMediaFile(n.cover)});break}this.rawUser.media[t][i]=r,i++}}get avatarFile(){return this.directory.find(t=>t.name===this.rawUser.profile.avatar)}getMediaFile(t){return this.directory.find(i=>i.name===t)}}const ie=T({__name:"UserSelectorAddMenuOptions",emits:["openCreateProfileDialog"],setup(e,{emit:t}){const i=M(),r=E(),o=t;async function l(){const n=await new Z("instagram").importFromDirectory(),s=await i.loadUser(n);await s.loadUserClient(),await s.save(),r.addUserToStorageIndex({username:s.raw.profile.username,platform:"instagram"})}return(a,n)=>(L(),O(C,null,[w(_,{onClick:n[0]||(n[0]=s=>o("openCreateProfileDialog"))},{default:P(()=>[w(F,{textContent:k(a.$t("common.actions.createProfile"))},null,8,["textContent"])]),_:1}),w(_,{onClick:l},{default:P(()=>[w(F,{textContent:k(a.$t("common.actions.importProfile"))},null,8,["textContent"])]),_:1})],64))}});export{ie as _};
